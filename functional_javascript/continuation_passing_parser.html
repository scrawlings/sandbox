<html>
<head>
  <title>parser experiment</title>
</head>
<body>
<script>

  function triplet(a, op) {
    return function(b, tokens, c) {
      c([a, op, b], tokens);
    }  
  }

  function cont_pair(fn, c) {
    return function() {
      var a = Array.prototype.slice.call(arguments);
      fn.apply(null, a.concat(c));
    }
  }

  function cont() {
    var fn, len;
    fn = arguments[arguments.length - 1];
    for (len = arguments.length - 2; len >= 0; --len) {
      fn = cont_pair(arguments[len], fn);
    }
    return fn
  }
  
  function send() {
    var fn, a;
    fn = arguments[arguments.length-1];
    a = Array.prototype.slice.call(arguments, 0, arguments.length-1);
    window.setTimeout(function() { fn.apply(null, a); }, 10);
  }




  function expr(a, tokens, c) {
    send(null, tokens, cont(term, expr_tail, c));
  }

  function expr_tail(a, tokens, c) {
    if (tokens[0] === '-' || tokens[0] === '+' ) {
      send(a, tokens.slice(1), cont(term, triplet(a, tokens[0]), expr_tail, c));
    } else {
      send(a, tokens, c);
    }  
  }

  function term(a, tokens, c) {
    send(null, tokens, cont(xpn, term_tail, c));
  }

  function term_tail(a, tokens, c) {
    if (tokens[0] === '/' || tokens[0] === '*' ) {
      send(null, tokens.slice(1), cont(xpn, triplet(a, tokens[0]),term_tail, c));
    } else {
      send(a, tokens, c);
    }  
  }

  function xpn(a, tokens, c) {
    send(null, tokens, cont(factor, xpn_tail, c));
  }

  function xpn_tail(a, tokens, c) {
    if (tokens[0] === '^') {
      send(null, tokens.slice(1), cont(xpn, triplet(a, tokens[0]), c));
    } else {
      send(a, tokens, c);
    }
  }

  function factor(a, tokens, c) {
    if (typeof(tokens[0]) === typeof(1)) { //'number') {
      send(tokens[0], tokens.slice(1), c);
    }  
    else if (tokens[0] === '(') {
      send(null, tokens.slice(1), cont(expr, factor_bracket_tail, c));
    } else {
      throw "bad factor";
    }
  }

  function factor_bracket_tail(a, tokens, c) {
    if (tokens[0] === ')') {
      send(a, tokens.slice(1), c);
    } else {
      throw "bad bracketing";
    }
  }





  try {
    send(null, [10, '+', 11, '*', 12], cont(expr, done));
    send(null, [13, '/', 14, '-', 15], cont(expr, done));
    send(null, [16, '-', 17, '-', 18, '-', 19], cont(expr, done));
    send(null, [20, '-', 21, '/', 22, '-', 23], cont(expr, done));
    send(null, [24, '/', '(', 25, '-', 26, ')'], cont(expr, done));
    send(null, [27, '-', 28, '^', 29, '^', 30, '^', 31], cont(expr, done));
    send(null, [32, '^', 33, '*', 34, '^', 35], cont(expr, done));
    send(null, [36, '^', 37, '*', '(', 38, ')', '^', 39], cont(expr, done));
  }
  catch(e) {
    document.write("<p>error: " + e);
  }

  function done(a, tokens, c) {
    array_writer(a);
    document.write('<br>');
  }

  function array_writer(a) {
    if (typeof(a) === 'object') {
      document.write('(');
      for(x in a) {
        array_writer(a[x]);
        document.write(' ');
    }
      document.write(')');
    } else {
      document.write(a);
    }
  }
  
</script>
</body>
